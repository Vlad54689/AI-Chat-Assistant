services:

  # System Database (For n8n workflows & history ONLY)
  n8n_db:
    image: postgres:16
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - ./n8n_system_data:/var/lib/postgresql/data 
    networks:
      - ai_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Project Database (Postgres with pgvector)
  project_db:
    image: pgvector/pgvector:pg16
    restart: always
    environment:
      - POSTGRES_USER=${APP_DB_USER}
      - POSTGRES_PASSWORD=${APP_DB_PASSWORD}
      - POSTGRES_DB=${APP_DB_NAME}
    volumes:
      - ./project_app_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - ai_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -U ${APP_DB_USER} -d ${APP_DB_NAME}"]
      interval: 5s
      timeout: 5s
      retries: 10

  # n8n - Automation Tool
  n8n:
    image: n8nio/n8n:2.3.6
    restart: always
    ports:
      - "127.0.0.1:5678:5678"
    environment:
      # --- Database Connection ---
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=n8n_db
      - DB_POSTGRESDB_PORT=5432

      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}

      - APP_DB_USER=${APP_DB_USER}
      - APP_DB_PASSWORD=${APP_DB_PASSWORD}
      - APP_DB_NAME=${APP_DB_NAME}

      # --- Ollama connection ---
      - OLLAMA_HOST=ollama:11434

      # --- Telegram ---
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ADMIN_TELEGRAM_ID=${ADMIN_TELEGRAM_ID}

      # Unlock env access
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false

      # --- Timezone ---
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      - TZ=${TZ}

      # --- Security & Config ---
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}

      # --- Performance ---
      - N8N_RUNNERS_ENABLED=true
      
      # --- Public URL ---
      - N8N_HOST=${NGROK_DOMAIN}
      - WEBHOOK_URL=https://${NGROK_DOMAIN}
      - N8N_SECURE_COOKIE=false
      # Trust the Ngrok proxy
      - N8N_PROXY_HOPS=1
      
    volumes:
      - ./n8n_data:/home/node/.n8n
    depends_on:
      n8n_db:
        condition: service_healthy
      project_db:
        condition: service_healthy
      ollama:
        condition: service_healthy
    networks:
      - ai_network

  # Ollama - AI Brain
  ollama:
    image: ollama/ollama:0.14.2
    container_name: ollama
    restart: always
    volumes:
      - ./ollama_data:/root/.ollama
    ports:
      - "127.0.0.1:11434:11434"
    networks:
      - ai_network
    healthcheck:
      test: ["CMD-SHELL", "ollama list || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Ollama Model Auto-Installer
  model-puller:
    image: ollama/ollama:0.14.2
    container_name: model_puller
    restart: "no"
    environment:
      - OLLAMA_HOST=ollama:11434
    networks:
      - ai_network
    depends_on:
      ollama:
        condition: service_healthy
    command: pull ${OLLAMA_MODEL}

  # Ngrok - Public Access
  ngrok:
    image: ngrok/ngrok:3
    command: http --domain=${NGROK_DOMAIN} n8n:5678
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    ports:
      - "127.0.0.1:4040:4040"
    depends_on:
      - n8n
    networks:
      - ai_network

networks:
  ai_network:
    driver: bridge